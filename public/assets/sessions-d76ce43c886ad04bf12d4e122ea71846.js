var authorizedSession=null,cardIndex=0,currentUser={id:null,email:null,username:null,slug:null,vote_btns:!0,admin:!1,unseen_bumps:0,unseen_refs:0},returnTrue=function(){return!0},hasSwiped=!1,hasKeySwiped=!1,hasSwitchedTags=!1,current_gallery_image=null,DEBUG=!1;(-1!=document.location.hostname.indexOf("localhost")||-1!=document.location.hostname.indexOf("staging.tagsurf.co")||-1!=document.location.hostname.indexOf("192.168")||-1!=document.location.hostname.indexOf("172.20"))&&(DEBUG=!0);var hasClass=function(e,t){return e.className&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(e.className)};Number.prototype.mod=function(e){return(this%e+e)%e},String.prototype.trunc=String.prototype.trunc||function(e){return this.length>e?this.substr(0,e-1)+"&hellip;":this};var toggleClass=function(e,t){var n=hasClass(this,e);n&&"on"!=t?this.classList.remove(e):n||"off"==t||this.classList.add(e)},galleries=["history","favorites","submissions","tag","bumps"],whichGallery=function(){for(var e=0;e<galleries.length;e++)if(-1!=document.location.pathname.indexOf(galleries[e]))return galleries[e];return null},isGallery=function(){var e=whichGallery();return null==e?!1:!0},isAuthorized=function(){return null!=authorizedSession?authorizedSession:(-1==document.location.href.indexOf("share")||-1!=document.location.href.indexOf("shares")?(authorizedSession=!0,isDesktop()||(currentUser.vote_btns=!1),setTimeout(function(){getUser()},3e3)):authorizedSession=!1,authorizedSession)},getUser=function(){authorizedSession&&!currentUser.id&&xhr("/api/users","GET",function(e){"not found"!=e.user&&(currentUser.id=e.user.id,currentUser.email=e.user.email,currentUser.username=e.user.username,currentUser.slug=e.user.slug,currentUser.admin=e.user.admin,currentUser.safeSurf=e.user.safe_mode,currentUser.unseen_bumps=e.unseen_bumps,currentUser.unseen_refs=e.unseen_referrals,currentUser.unseen_bumps+currentUser.unseen_refs!=0&&updateMenuBadges(currentUser.unseen_bumps+currentUser.unseen_refs),isGallery()&&"bumps"==whichGallery()&&updateGalleryBadges(currentUser.unseen_refs,currentUser.unseen_bumps,!0))},function(e){"not found"==e.user&&DEBUG&&console.log("Error: User not found")}),setTimeout(function(){userStatsPoller()},5e3)},userStatsPoller=function(){xhr("/api/users","GET",function(e){"not found"!=e.user&&(currentUser.safeSurf=e.user.safe_mode,(currentUser.unseen_bumps!=e.unseen_bumps||currentUser.unseen_refs!=e.unseen_referrals)&&(currentUser.unseen_bumps=e.unseen_bumps,currentUser.unseen_refs=e.unseen_referrals,updateMenuBadges(currentUser.unseen_bumps+currentUser.unseen_refs),isGallery()&&"bumps"==whichGallery()&&updateGalleryBadges(currentUser.unseen_refs,currentUser.unseen_bumps)))},function(e){"not found"==e.user&&DEBUG&&console.log("Error: User not found")}),setTimeout(function(){userStatsPoller()},5e3)},current_tag,current_deck,cardCbs,tinput,inputContainer,slideContainer,scrollContainer,closeAutoComplete=function(e){e?(slideContainer.className="",scrollContainer.insertBefore(inputContainer,scrollContainer.firstChild)):modal.backOff(function(){slideContainer.className="",scrollContainer.insertBefore(inputContainer,scrollContainer.firstChild)}),tinput.active=!1},clearStack=function(){var e=current_deck.getEndCard();e&&e.unshow();for(var t=slideContainer.childNodes.length,n=0;t>n;n++)current_deck.cards[n].showing&&current_deck.cards[n].unshow()},newtags=[],pushTags=function(){if(newtags.length>0){for(;newtags.length;)xhr("/api/media/"+currentMedia.id+"/tags/"+newtags.shift(),"POST",null,null);autocomplete.populate()}},popTrending,fadeInBody=function(){addCss({"html, body":function(){return"width: "+window.innerWidth+"px; height: "+window.innerHeight+"px; opacity: 1;"}})},shareVotes=[],stashVotesAndLogin=function(){sessionStorage.setItem("lastPath",current_tag+"~"+currentMedia.id),sessionStorage.setItem("shareVotes",JSON.stringify(shareVotes)),window.location="/users/sign_in"};stashVotes=function(){sessionStorage.setItem("lastPath",current_tag+"~"+currentMedia.id),sessionStorage.setItem("shareVotes",JSON.stringify(shareVotes))};var messageBox=function(e,t,n,s,r){var i=document.createElement("div"),o=document.createElement("div"),a=document.createElement("img"),u=document.createElement("p"),d=document.createElement("p"),l=document.createElement("div");r="undefined"==typeof r?!1:r,o.className="close-button-container pointer",a.className="x-close-button",a.src="http://assets.tagsurf.co/img/Close.png",gesture.listen("down",o,modal.callPrompt),o.appendChild(a),i.appendChild(o),u.className="prompt-title",u.innerHTML=e?e:"Oops",i.appendChild(u),d.className="prompt-message",d.innerHTML=t?t:"Something went wrong",i.appendChild(d),l.className="msgbox-btn","undefined"==typeof n?(l.innerHTML="OK",s?gesture.listen("tap",l,s):gesture.listen("tap",l,modal.callPrompt)):(l.innerHTML=n,"login"!=n||s?s?gesture.listen("tap",l,s):gesture.listen("tap",l,modal.callPrompt):gesture.listen("tap",l,function(){window.location="/users/sign_in"})),gesture.listen("down",l,function(){l.classList.add("ts-active-button")}),gesture.listen("up",l,function(){l.classList.remove("ts-active-button")}),i.appendChild(l),modal.promptIn(i,null,r)},buildVoteButtons=function(e,t){var n=document.createElement("div"),s=document.createElement("div"),r=document.createElement("img"),i=document.createElement("img");r.src="http://assets.tagsurf.co/img/downvote_btn.png",i.src="http://assets.tagsurf.co/img/upvote_btn.png",r.id="downvote-icon",i.id="upvote-icon",s.className="vote-button hidden",s.id="vote-button-left",n.className="vote-button hidden",n.id="vote-button-right",s.appendChild(r),n.appendChild(i),gesture.listen("down",s,function(){s.firstChild.src="http://assets.tagsurf.co/img/downvote_btn-invert.png"}),gesture.listen("up",s,function(){setTimeout(function(){s.firstChild.src="http://assets.tagsurf.co/img/downvote_btn.png"},200)}),gesture.listen("tap",s,function(){modal.zoom.zoomed&&modal.callZoom(1),cardCbs.drag("left",-1,-1),setTimeout(function(){t("left")},200),analytics.track("Tap Downvote Button")}),gesture.listen("down",n,function(){n.firstChild.src="http://assets.tagsurf.co/img/upvote_btn-invert.png"}),gesture.listen("up",n,function(){setTimeout(function(){n.firstChild.src="http://assets.tagsurf.co/img/upvote_btn.png"},200)}),gesture.listen("tap",n,function(){modal.zoom.zoomed&&modal.callZoom(1),cardCbs.drag("right",1,1),setTimeout(function(){t("right")},200),analytics.track("Tap Upvote Button")}),document.body.appendChild(s),document.body.appendChild(n)},voteButtonsOn=function(){document.getElementById("vote-button-right")&&(toggleClass.apply(document.getElementById("vote-button-right"),["hidden","off"]),toggleClass.apply(document.getElementById("vote-button-left"),["hidden","off"]))},voteButtonsOff=function(){document.getElementById("vote-button-right")&&(toggleClass.apply(document.getElementById("vote-button-right"),["hidden","on"]),toggleClass.apply(document.getElementById("vote-button-left"),["hidden","on"]))},flashVoteButton=function(e){"right"==e?(document.getElementById("upvote-icon").src="http://assets.tagsurf.co/img/upvote_btn-invert.png",setTimeout(function(){document.getElementById("upvote-icon").src="http://assets.tagsurf.co/img/upvote_btn.png"},300)):"left"==e&&(document.getElementById("downvote-icon").src="http://assets.tagsurf.co/img/downvote_btn-invert.png",setTimeout(function(){document.getElementById("downvote-icon").src="http://assets.tagsurf.co/img/downvote_btn.png"},300))},currentMedia,panicCb,checkShare=function(e){var t=currentMedia;if(t&&-1!=t.type.indexOf("content")){if(share.on(t,e),refer.on(t),whichGallery())return;panic.on(t,panicCb),currentUser.vote_btns&&voteButtonsOn()}else t&&"login"==t.type?currentUser.vote_btns&&voteButtonsOn():(share.off(),panic.off(),voteButtonsOff(),addBarSlid&&slideAddBar())},setCurrentMedia=function(e,t){currentMedia=e,checkShare(t)},_addCss=function(e){var t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t)},addedCss=[],addCss=function(e,t){var n,s="";for(n in e)s+=n+" { "+e[n]()+" } ";isNaN(t)&&addedCss.push(e),_addCss(s)},getOrientation=function(){return window.innerWidth<window.innerHeight?"portrait":"landscape"},maxCardHeight,resizeCb,setMaxCardHeight=function(){maxCardHeight=window.innerHeight-240},setResizeCb=function(e){resizeCb=e};setMaxCardHeight();var lastWidth=window.innerWidth;window.onresize=function(){!isDesktop()&&lastWidth==window.innerWidth||throbber.active||(lastWidth=window.innerWidth,setMaxCardHeight(),addedCss.forEach(addCss),resizeCb&&resizeCb())};var xhr=function(e,t,n,s,r,i){var o=new XMLHttpRequest;DEBUG&&console.log("XHR Request. Path: "+e+" action: "+(t||"GET")),"undefined"==typeof r&&(r=!0),o.open(t||"GET",e,r),"PATCH"==t&&o.setRequestHeader("Content-type","application/json"),o.onreadystatechange=function(){if(4==o.readyState){var t="<"==o.responseText.charAt(0)?{errors:o.responseText}:JSON.parse(o.responseText);if(t.errors||200!=o.status){if(s&&s(t,o.status),DEBUG&&401!=o.status&&404!=o.status){var r="XHR error! Request failed. Path:"+e+" Errors: "+t.errors+" Response: "+o.responseText+" Status: "+o.status;console.log(r),!isDesktop()&&alert(r)}}else n&&n(t)}},o.send(i)},mod=function(e){for(var t=e.targets?e.targets:e.target?[e.target]:e.className?document.getElementsByClassName(e.className):e.id?[document.getElementById(e.id)]:[],n=e.property||"display",s=e.value||(e.show?"block":e.hide?"none":""),r=0;r<t.length;r++)t[r].style[n]=s},__ua=navigator.userAgent,_ua={isUIWebView:/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(__ua),isSafariOrUIWebView:/(iPhone|iPod|iPad).*AppleWebKit/i.test(__ua),isIphone:-1!=__ua.indexOf("iPhone"),isIpad:-1!=__ua.indexOf("iPad"),isIos:-1!=__ua.indexOf("iPhone")||-1!=__ua.indexOf("iPad"),isMobile:-1!=__ua.toLowerCase().indexOf("mobile"),isAndroid:-1!=__ua.indexOf("Android"),isNativeAndroid:-1!=__ua.indexOf("AndroidWebView"),isFacebook:-1!=__ua.indexOf("FB"),isStockAndroid:-1!=__ua.indexOf("Mozilla/5.0")&&-1!=__ua.indexOf("Android ")&&-1!=__ua.indexOf("AppleWebKit")&&-1==__ua.indexOf("Chrome")},isIos=function(){return _ua.isIos},isUIWebView=function(){return _ua.isUIWebView&&!_ua.isFacebook},isIpad=function(){return _ua.isIpad},isIphone=function(){return _ua.isIphone},isDesktop=function(){return!_ua.isMobile&&!_ua.isAndroid&&!_ua.isIos},isTablet=function(){return _ua.isIpad||_ua.isAndroid&&!_ua.isMobile},isMobile=function(){return _ua.isMobile},isAndroid=function(){return _ua.isAndroid},isNativeAndroid=function(){return _ua.isNativeAndroid},isStockAndroid=function(){return _ua.isStockAndroid},isFacebook=function(){return _ua.isFacebook},isNarrow=function(){return window.innerWidth<700},trans=function(e,t,n,s){var r,i=n&&1==n.split(" ").length,o=function(){n&&(i?e.classList.remove(n):e.style["-webkit-transition"]=""),s&&(e.style["-webkit-transform"]=""),r&&(clearTimeout(r),r=null),e.removeEventListener("webkitTransitionEnd",o,!1),t&&t()};e.addEventListener("webkitTransitionEnd",o,!1),n&&(i?e.classList.add(n):(e.style["-webkit-transition"]=n,r=setTimeout(o,parseInt(n.split(" ")[1])))),s&&(e.style["-webkit-transform"]=s)},validEmail=function(e){var t=e.indexOf("@",1),n=e.indexOf(".",t);return-1==t||-1==n||n==e.length-1||t+2>n?!1:!0},requestAnimFrame;!function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var n=(new Date).getTime(),s=Math.max(0,16-(n-e)),r=window.setTimeout(function(){t(n+s)},s);return e=n+s,r}),requestAnimFrame=window.requestAnimationFrame,window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var stroke={keys:{},cbs:{up:{},down:{}},init:function(){window.onkeydown=function(e){e=e||window.event;var t=e.keyCode||e.which,n=stroke.cbs.down.always,s=stroke.cbs.down[t],r=Date.now(),i=stroke.keys[t]=stroke.keys[t]&&!stroke.keys[t].up?stroke.keys[t]:{duration:0};i.down&&(i.duration+=r-i.down),i.down=r,n&&n(i),s&&s(i)},window.onkeyup=function(e){e=e||window.event;var t=e.keyCode||e.which,n=Date.now(),s=stroke.keys[t]=stroke.keys[t]||{down:n},r=stroke.cbs.up.always,i=stroke.cbs.up[t];s.up=n,s.duration+=s.up-s.down,r&&r(s),i&&i(s)}},isDown:function(e){var t=stroke.keys[e],n=t&&!t.up;return n},listen:function(e,t,n){stroke.cbs[e][t||"always"]=n},unlisten:function(e,t){delete stroke.cbs[e][t||"always"]}};stroke.init();var gesture={gid:0,preventDefault:!0,stopPropagation:!0,thresholds:{swipe:{minDistance:35,maxTime:400,minDP:600,maxDP:1e3},drag:{minDP:0,maxDP:1e3},tap:{maxDistance:10,maxTime:700,waitTime:300,maxCount:2},hold:{maxDistance:null,interval:1e3},up:{androidDelay:600},pinch:{}},_vars:{active:!1,startTime:null,dragTime:null,startPos:null,lastPos:null,tapCount:0,holdCount:0,tapTimeout:null,holdInterval:null,stopTimeout:null,firstPinch:null,stopPropagation:!1,preventDefault:!1,iosPinch:!1,iosPinching:!1},gevents:{GestureStart:"gesturestart",GestureChange:"gesturechange",GestureEnd:"gestureend"},events:isMobile()&&{Start:"touchstart",Stop:"touchend",Move:"touchmove",Cancel:"touchcancel"}||{Start:"mousedown",Stop:"mouseup",Move:"mousemove"},handlers:{drag:{},swipe:{},tap:{},up:{},down:{},hold:{},pinch:{}},tuneThresholds:function(){if(!isIos())for(var e in gesture.thresholds)for(var t in gesture.thresholds[e]){var n=t.slice(3);"Distance"==n?gesture.thresholds[e][t]/=2:"DP"==n&&(gesture.thresholds[e][t]*=2)}},getPos:function(e){return void 0==e.x&&(e.x=e.pageX||e.changedTouches[0].pageX,e.y=e.pageY||e.changedTouches[0].pageY),{x:e.x,y:e.y}},getDiff:function(e,t){var n={};return n.x=t.x-e.x,n.y=t.y-e.y,n.distance=Math.sqrt(n.x*n.x+n.y*n.y),n.direction=Math.abs(n.x)>Math.abs(n.y)?n.x>0?"right":"left":n.y>0?"down":"up",n},pinchDiff:function(e){return isIos()?e.scale:gesture.getDiff(gesture.getPos(e.touches[0]),gesture.getPos(e.touches[1]))},pixelsPerSecond:function(e,t,n){var s=gesture.thresholds[n];return Math.min(s.maxDP,Math.max(s.minDP,e/t))*(isIos()?1:.5)},isMulti:function(e){return isMobile()&&e.touches.length>1},onGestureStart:function(){},onGestureChange:function(e,t){gesture.triggerPinch(t,Math.pow(e.scale,1/3))},onGestureEnd:function(e,t){gesture.triggerPinch(t),t.gvars.iosPinching=!1},onStart:function(e,t){var n=gesture.thresholds,s=t.gvars;return s.active=!0,s.holdCount=0,s.startTime=s.dragTime=Date.now(),s.startPos=s.lastPos=gesture.getPos(e),s.tapTimeout&&(clearTimeout(s.tapTimeout),s.tapTimeout=null),gesture.isMulti(e)?isAndroid()?s.firstPinch=gesture.pinchDiff(e):s.iosPinching=!0:s.holdInterval=setInterval(function(){return!s.active||n.hold.maxDistance&&n.hold.maxDistance<gesture.getDiff(s.startPos,s.lastPos).distance?(clearInterval(s.holdInterval),s.holdInterval=null,void 0):(s.holdCount+=1,gesture.triggerHold(t,n.hold.interval*s.holdCount),void 0)},n.hold.interval),gesture.triggerDown(t)},onStop:function(e,t,n){var s=t.gvars;if(!n&&s.holdInterval&&(clearInterval(s.holdInterval),s.holdInterval=null),s.active){var r=gesture.thresholds,i=gesture.getPos(e),o=gesture.getDiff(s.startPos,i),a=Date.now()-s.startTime;return s.active=!(!e.touches||!e.touches.length),e.touches&&1==e.touches.length&&gesture.triggerPinch(t),s.active||s.iosPinching||(a<r.swipe.maxTime&&o.distance>r.swipe.minDistance?gesture.triggerSwipe(t,o.direction,o.distance,o.x,o.y,gesture.pixelsPerSecond(o.distance,a,"swipe")):a<r.tap.maxTime&&o.distance<r.tap.maxDistance&&(s.tapCount+=1,s.tapCount==r.tap.maxCount?gesture.triggerTap(t):s.tapTimeout=setTimeout(gesture.triggerTap,r.tap.waitTime,t))),gesture.triggerUp(t,n)}},onMove:function(e,t){var n=t.gvars;if(n.active){var s=gesture.getPos(e),r=gesture.getDiff(n.lastPos,s),i=Date.now(),o=i-n.dragTime;if(n.lastPos=s,n.dragTime=i,!gesture.isMulti(e))return gesture.triggerDrag(t,r.direction,r.distance,r.x,r.y,gesture.pixelsPerSecond(r.distance,o,"drag"));isAndroid()&&gesture.triggerPinch(t,gesture.pinchDiff(e).distance/n.firstPinch.distance)}},gWrap:function(e){var t={};return["GestureStart","GestureChange","GestureEnd"].forEach(function(n){t[n]=function(t){return t.preventDefault(),t.stopPropagation(),gesture["on"+n](t,e)||!1}}),t},eWrap:function(e){var t={};return["Start","Stop","Move"].forEach(function(n){t[n]=function(t){return e.gvars.preventDefault&&t.preventDefault(),e.gvars.stopPropagation&&t.stopPropagation(),gesture["on"+n](t,e)||gesture.preventDefault&&t.preventDefault()||gesture.stopPropagation&&t.stopPropagation()||!1}}),gesture.events.Cancel&&(t.Cancel=t.Stop),t},listen:function(e,t,n,s,r){if(!t.gid){t.gid=++gesture.gid;var i=t.listeners=gesture.eWrap(t);for(var o in gesture.events)t.addEventListener(gesture.events[o],i[o]);t.gvars=JSON.parse(JSON.stringify(gesture._vars))}if("pinch"==e&&isIos()){var a=gesture.gWrap(t);for(var o in gesture.gevents)t.addEventListener(gesture.gevents[o],a[o]);for(var u in a)t.listeners[u]=a[u];t.gvars.iosPinch=!0}t.gvars.stopPropagation=s,t.gvars.preventDefault=r,gesture.handlers[e][t.gid]||(gesture.handlers[e][t.gid]=[]),gesture.handlers[e][t.gid].push(n)},unlisten:function(e){if(e.gid){var t=e.listeners;for(var n in gesture.events)e.removeEventListener(gesture.events[n],t[n]);if(e.gvars.iosPinch)for(var n in gesture.gevents)e.removeEventListener(gesture.gevents[n],t[n]);for(var s in gesture.handlers)e.gid in gesture.handlers[s]&&delete gesture.handlers[s][e.gid];delete e.gid}},triggerPinch:function(e,t){var n=gesture.handlers.pinch[e.gid];if(n)for(var s=0;s<n.length;s++)n[s](t)},triggerSwipe:function(e,t,n,s,r,i){var o=gesture.handlers.swipe[e.gid];if(hasSwiped=!0,o)for(var a=0;a<o.length;a++)o[a](t,n,s,r,i)},triggerTap:function(e){var t=e.gvars,n=gesture.handlers.tap[e.gid];if(n)for(var s=0;s<n.length;s++)n[s](t.tapCount);t.tapCount=0,t.tapTimeout=null},triggerDrag:function(e,t,n,s,r,i){var o=!1,a=gesture.handlers.drag[e.gid];if(a)for(var u=0;u<a.length;u++)o=a[u](t,n,s,r,i)||o;return o},triggerHold:function(e,t){var n=gesture.handlers.hold[e.gid];if(n)for(var s=0;s<n.length;s++)n[s](t)},triggerUp:function(e,t){var n=!1,s=gesture.handlers.up[e.gid];if(s)for(var r=0;r<s.length;r++)n=s[r](t)||n;return n},triggerDown:function(e){var t=!1,n=gesture.handlers.down[e.gid];if(n)for(var s=0;s<n.length;s++)t=n[s]()||t;return t}};gesture.tuneThresholds();